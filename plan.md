# 聊天工具项目计划

## 项目目标与当前状态
- 目标：实现基于 TCP 的 C/S 聊天工具（Linux），服务端高性能可扩展，客户端使用 SDL 图形界面，支持文字/表情/文件发送、在线用户列表、群聊/私聊、登录注册、聊天记录持久化、断点续传与校验。
- 当前状态：已完成服务端与公共模块的主要功能（协议、登录注册、群管理、消息/文件持久化与离线补发/断点续传、历史分页接口）。客户端网络/状态与文件传输管理已完成，SDL UI 基础交互已完成。

## 可执行任务清单（Checklist）
- [x] T1 项目骨架与构建系统
- [x] T2 协议与公共模块（共享头/序列化）
- [x] T3 服务端核心网络与会话管理
- [x] T4 数据库与业务服务（用户/群/消息/文件）
- [x] T4.1 历史消息分页接口（服务端）
- [x] T5 文件传输（断点续传与校验）
- [x] T6 客户端网络与状态管理
- [x] T7 客户端 SDL UI 与交互
- [ ] T8 集成测试与运行说明

## 任务详情

### T1 项目骨架与构建系统
- 目标：建立目录结构、CMake 构建、依赖集成（SDL2/SDL2_ttf/SQLite3/bcrypt/SHA-256/JSON）。
- 涉及模块/文件：
  - `CMakeLists.txt`
  - `cmake/`（依赖查找）
  - `src/common/` `src/server/` `src/client/`
  - `config/server.json` `config/client.json`
- 验收条件：
  - `server` 与 `client` 两个可执行文件可编译生成。
  - 能读取 JSON 配置并输出基本日志。
- 测试点：
  - CMake 配置正确；缺少依赖时有清晰错误提示。
- 回滚点：
  - 删除新增目录与 CMake 文件，恢复空仓库状态。

### T2 协议与公共模块（共享头/序列化）
- 目标：定义协议包头、消息类型、JSON 元数据规范、二进制分块规则；实现编解码与校验。
- 涉及模块/文件：
  - `src/common/protocol/`（包头、类型、编解码）
  - `src/common/net/`（收发缓冲、粘包处理）
  - `src/common/crypto/`（SHA-256）
- 验收条件：
  - 单元测试或样例能正确打包/解包 JSON 与二进制分块。
- 测试点：
  - 粘包/拆包、最大包长、防止越界。
- 回滚点：
  - 回滚 `src/common` 目录。

### T3 服务端核心网络与会话管理
- 目标：实现 TCP 监听、epoll 事件循环、连接管理、登录态、在线用户列表广播。
- 涉及模块/文件：
  - `src/server/net/`（accept/epoll/conn）
  - `src/server/session/`（会话与在线状态）
  - `src/server/main.cpp`
- 验收条件：
  - 多客户端可连接，登录成功后广播在线用户列表。
- 测试点：
  - 1000 连接压力下无明显阻塞；断开连接能正确清理会话。
- 回滚点：
  - 回滚 `src/server` 网络/会话相关代码。

### T4 数据库与业务服务（用户/群/消息/文件）
- 目标：建立 SQLite schema 与 DAO；实现注册/登录、群管理、消息入库与离线补发。
- 涉及模块/文件：
  - `src/server/storage/`（SQLite 连接/迁移/DAO）
  - `src/server/services/`（Auth/Group/Message）
  - `data/db/`（运行时数据目录）
- 验收条件：
  - 注册/登录正常；群创建/加入/改名/踢人/解散可用。
  - 消息写入数据库，离线用户登录后补发。
- 测试点：
  - SQL 注入防护（参数化）；数据库崩溃/锁冲突处理。
- 回滚点：
  - 回滚 schema 与服务端业务层代码。

### T4.1 历史消息分页接口（服务端）
- 目标：实现 HistoryFetch/HistoryResponse，支持 `before_message_id` 游标分页，默认 limit=100，仅返回当前会话历史。
- 涉及模块/文件：
  - `src/server/services/message_service.*`（历史查询）
  - `src/server/net/tcp_server.*`（HistoryFetch 处理）
- 验收条件：
  - 登录后能拉取当前会话最近 100 条；向上滚动可继续拉取 100 条。
- 测试点：
  - 无历史/少于 100 条；游标边界（before_message_id=0）。
- 回滚点：
  - 回滚服务端历史消息接口相关改动。

### T5 文件传输（断点续传与校验）
- 目标：实现上传到服务端、断点续传、SHA-256 校验、客户端下载。
- 涉及模块/文件：
  - `src/server/services/file_service.cpp`
  - `src/client/file_transfer/`
  - `data/files/`（服务端保存目录）
- 验收条件：
  - 中断后可续传；校验失败会拒绝完成并提示。
  - 群聊文件可被群内下载；私聊文件仅目标可下载。
- 测试点：
  - 大文件多分块；断网重连后续传。
- 回滚点：
  - 回滚文件传输相关模块与元数据表。

### T6 客户端网络与状态管理
- 目标：实现客户端网络层、协议处理、会话状态与历史消息加载。
- 涉及模块/文件：
  - `src/client/net/`
  - `src/client/state/`
  - `src/client/history/`
- 验收条件：
  - 登录后能获取在线用户列表。
  - 进入会话自动拉取 100 条历史（before_message_id），滚动再拉取 100 条。
- 测试点：
  - 网络断开后的重连与状态恢复。
- 回滚点：
  - 回滚客户端网络与状态管理代码。

### T7 客户端 SDL UI 与交互
- 目标：实现聊天窗口、用户列表、群列表、消息区、输入框、文件进度条、表情渲染。
- 涉及模块/文件：
  - `src/client/ui/`（SDL 渲染与布局）
  - `assets/fonts/`（Emoji 字体）
- 验收条件：
  - UI 可用：登录/群聊/私聊/文件发送/下载/退出功能完整。
- 测试点：
  - 不同分辨率显示、Unicode 表情渲染正确。
- 回滚点：
  - 回滚 UI 模块与字体资源。

### T8 集成测试与运行说明
- 目标：提供基本运行步骤与验证清单。
- 涉及模块/文件：
  - `README.md`
  - `scripts/`（可选启动脚本）
- 验收条件：
  - 提供可复现的构建与运行说明。
- 测试点：
  - 本地双开客户端与服务端通过 TCP 通信。
- 回滚点：
  - 回滚文档与脚本。

## 依赖关系
- T1 为基础，先完成后才能进入后续任务。
- T2 依赖 T1；T3/T6 依赖 T2。
- T4 依赖 T1/T2；T5 依赖 T3/T4；T7 依赖 T6；T8 依赖全部完成。

## 风险与注意事项
- SDL_ttf 的彩色 Emoji 支持依赖字体与 FreeType 版本，可能需要降级方案。
- 1000 并发需避免阻塞 I/O；SQLite 写入需谨慎设计（WAL/批量写）。
- 公网部署需要防火墙与端口转发配置（非代码问题）。
- 文件断点续传与校验需处理不一致/缺块与重复块。
